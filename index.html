<!DOCTYPE html>
<html lang="en">

<head>
    declare global {
    interface Window {
    updateDisplay: () => void;
    saveGame: () => void;
    }
    }
    
    <script type="module" >

        import { Store } from '/.Store.js';
        // åœ¨æ¸¸æˆåˆå§‹åŒ–ååˆ›å»ºStoreå®ä¾‹
        let store;
        function initGameState(savedData = {}) { // å¼ºåˆ¶è®¾ç½®é»˜è®¤ç©ºå¯¹è±¡
            const DEFAULT_VALUES = {
                gold: 0,
                pickaxeLevel: 1,
                pickaxeCost: 10,
                miners: 0,
                minerCost: 50, // æ–°å¢å…³é”®å­—æ®µ
                critChanceLevel: 1,
                critMultiplierLevel: 1,
                offlineMultiplierLevel: 1,
                critChanceCost: 100,
                critMultiplierCost: 150,
                offlineMultiplierCost: 200,
                prestige: 0
            };

            return {
                ...DEFAULT_VALUES, // ä¼˜å…ˆä½¿ç”¨é»˜è®¤å€¼
                ...savedData,      // è¦†ç›–æœ‰æ•ˆä¿å­˜æ•°æ®
                // é‡æ–°è®¡ç®—æ´¾ç”Ÿå±æ€§
                critChance: calculateCritChance(savedData),
                critMultiplier: calculateCritMultiplier(savedData),
                offlineMultiplier: calculateOfflineMultiplier(savedData)
            };
        }

        // ä¸“ç”¨è®¡ç®—å‡½æ•°
        function calculateCritChance({ critChanceLevel = 1 }) {
            const upgrades = critChanceLevel - 1;
            return 0.1 + Math.min(upgrades, 5) * 0.03 + Math.max(upgrades - 5, 0) * 0.02;
        }

        function calculateCritMultiplier({ critMultiplierLevel = 1 }) {
            return 2 + (critMultiplierLevel - 1) * 0.5;
        }

        function calculateOfflineMultiplier({ offlineMultiplierLevel = 1 }) {
            return 1 + (offlineMultiplierLevel - 1) * 0.5;
        }


        function initGame() {
            // åˆ é™¤åŸæœ‰çš„å…¨å±€å˜é‡å£°æ˜ï¼Œæ›¿æ¢ä¸ºï¼š
            let gameState = {
                gold: savedData.gold || 0,
                pickaxeLevel: savedData.pickaxeLevel || 1,
                pickaxeCost: savedData.pickaxeCost || 10,
                miners: savedData.miners || 0,
                minerCost: savedData.minerCost || 50,
                lastSave: savedData.lastSave || Date.now(),
                // æ·»åŠ é»˜è®¤å€¼ä¿æŠ¤
                critChanceLevel: savedData.critChanceLevel || 1,
                critMultiplierLevel: savedData.critMultiplierLevel || 1,
                critChanceCost: savedData.critChanceCost || 100,
                critMultiplierCost: savedData.critMultiplierCost || 150,
                offlineMultiplierLevel: savedData.offlineMultiplierLevel || 1,
                offlineMultiplierCost: savedData.offlineMultiplierCost || 200,
                upgradeSound: upgradeSound,
                quests: savedData.quests || generateRandomQuests(3),
                critChance: calculateCritChance(savedData),
                critMultiplier: calculateCritMultiplier(savedData),
                offlineMultiplier: calculateOfflineMultiplier(savedData),
                prestige: savedData.prestige || 0, // æ·»åŠ æ­¤è¡Œ
            };
            store = new Store(gameState);
            window.gameState = gameState;

            // ç§»åŠ¨ç¦»çº¿æ”¶ç›Šè®¡ç®—åˆ°è¿™é‡Œ
            const offlineSeconds = Math.floor((Date.now() - savedData.lastSave) / 1000);
            if (offlineSeconds > 0) {
                const offlineGold = Math.round(gameState.miners * offlineSeconds * gameState.offlineMultiplier
                    * (1 + gameState.critChance * (gameState.critMultiplier - 1)));
                if (offlineGold > 0) {
                    gameState.gold += Math.round(offlineGold);
                    showFloatingText(offlineGold.toFixed(1), true);
                    const formattedTime = formatTime(offlineSeconds);
                    setTimeout(() => {
                        alert(`ğŸ“¦ ç¦»çº¿æ”¶ç›Š\n\nç¦»çº¿æ—¶é—´ï¼š${formattedTime}\nè·å¾—é‡‘å¸ï¼š${Math.round(offlineGold)}`);
                    }, 300);
                }
            }

            updateDisplay(); // ç¡®ä¿åœ¨åˆå§‹åŒ–åæ›´æ–°
            // ...ä¿æŒå…¶ä½™äº‹ä»¶ç›‘å¬ä»£ç ä¸å˜
            document.getElementById('upgradePickaxe').onclick = () => store.upgradePickaxe();
            document.getElementById('buyMiner').onclick = () => store.buyMiner();
            document.getElementById('upgradeCritChance').onclick = () => store.upgradeCritChance();
            document.getElementById('upgradeCritMultiplier').onclick = () => store.upgradeCritMultiplier();
            document.getElementById('upgradeOfflineMultiplier').onclick = () => store.upgradeOfflineMultiplier();
        }
        // åˆå§‹åŒ–æ¸¸æˆ
        initGame();
        updateQuests();
    </script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é‡‘å¸çŸ¿å·¥æ”¾ç½®æ¸¸æˆ</title>
    <style>
        /* æ–°å¢èƒŒæ™¯æ ·å¼ */
        body {
            background-image: url("mine_bg.jpg");
            background-size: cover;
            background-repeat: no-repeat;
            background-position: center;
            background-attachment: fixed;
        }

        body {
            font-family: Arial, sans-serif;
            margin: 0;
            min-height: 100vh;
            position: relative;
            background-color: rgba(42, 42, 42, 0.85);
            /* åŠé€æ˜æ·±è‰²å åŠ å±‚ */
            background-blend-mode: multiply;
            /* æ··åˆæ¨¡å¼å¢å¼ºå¯è¯»æ€§ */
        }

        :root {
            --gold: #ffd700;
            --dark-bg: #2a2a2a;
            --button-bg: #3a3a3a;
            --button-hover: #4a4a4a;
        }

        /* æ–°å¢å•†åº—å®¹å™¨æ ·å¼ */
        #shop-container {
            position: fixed;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding: 20px;
            width: 280px;
            max-height: 90vh;
            overflow-y: auto;
            background: var(--dark-bg);
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
            z-index: 999;
        }

        /* è°ƒæ•´æ ‡é¢˜ä½ç½® */
        h2 {
            position: fixed;
            left: 20px;
            top: 20px;
            color: var(--gold);
            margin: 0;
            z-index: 1000;
            background: var(--dark-bg);
            padding: 10px 20px;
            border-radius: 8px;
            width: auto;
        }

        /* ä¿®æ”¹å•†åº—å•†å“é¡¹ */
        .shop-item {
            width: 100%;
            margin: 0;
        }

        /* é‡‘å¸è®¡æ•°å™¨å‡çº§ */
        #gold-counter {
            position: fixed;
            right: 20px;
            top: 20px;
            font-size: 28px;
            /* å¢å¤§å­—å· */
            color: #FFD700;
            /* ä½¿ç”¨æ›´äº®çš„é‡‘è‰² */
            padding: 15px 25px;
            background: rgba(0, 0, 0, 0.8);
            /* æ·±è‰²èƒŒæ™¯å¢åŠ å¯¹æ¯”åº¦ */
            border-radius: 10px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.8);
            /* å¢å¼ºæ–‡å­—é˜´å½± */
            z-index: 1000;
            /* ç¡®ä¿åœ¨æœ€é¡¶å±‚ */
        }

        .mine-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 85vh;
            /* å‚ç›´å±…ä¸­ */
        }

        /* æŒ–çŸ¿ä¸»æŒ‰é’®ç‰¹æ®Šæ ·å¼ */
        .mine-container button {
            background: linear-gradient(145deg, #cd983a, #b57a2a);
            padding: 20px 40px;
            font-size: 20px;
            border-radius: 15px;
        }

        .mine-container button:hover:not(:disabled) {
            background: linear-gradient(145deg, #ddaf4a, #c58b3a);
        }

        button {
            padding: 12px 24px;
            font-size: 16px;
            margin: 10px;
            cursor: pointer;
            border: none;
            border-radius: 8px;
            background: linear-gradient(145deg, var(--button-bg), #333);
            color: white;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            position: relative;
            overflow: hidden;
        }

        /* æŒ‰é’®æ‚¬åœæ•ˆæœ */
        button:hover:not(:disabled) {
            background: linear-gradient(145deg, var(--button-hover), #444);
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.3);
        }

        /* æŒ‰é’®ç‚¹å‡»æ•ˆæœ */
        button:active:not(:disabled) {
            transform: translateY(1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        /* æŒ‰é’®ç¦ç”¨çŠ¶æ€ */
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            background: linear-gradient(145deg, #2a2a2a, #333);
        }

        /* æŒ‰é’®é‡‘è‰²è¾¹æ¡†ç‰¹æ•ˆ */
        button::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border: 2px solid transparent;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        button:hover::after {
            border-color: var(--gold);
        }


        .shop-item button:hover:not(:disabled) {
            background: linear-gradient(145deg, #4a6fdd, #3a5bb5);
        }

        .shop-item:hover {
            transform: translateY(-5px);
            border-color: var(--gold);
        }

        /* æ•°å€¼æ˜¾ç¤ºç¾åŒ– */
        .shop-item h3 {
            color: var(--gold);
            margin: 8px 0;
            font-size: 1.2em;
        }

        .shop-item p {
            color: #ccc;
            margin: 8px 0;
        }

        /* ä¿®æ”¹æš´å‡»æ¶ˆæ¯æ ·å¼ */
        #crit-message {
            display: none;
            position: fixed;
            left: 50%;
            top: 40%;
            transform: translate(-50%, -50%);
            font-size: 32px;
            /* å¢å¤§å­—å· */
            color: #FFD700;
            text-shadow:
                0 0 10px #FF4500,
                /* æ·»åŠ æ©™è‰²å…‰æ™• */
                2px 2px 4px rgba(0, 0, 0, 0.8);
            font-weight: bold;
            pointer-events: none;
            z-index: 9999;
            /* æå‡åˆ°æœ€é«˜å±‚çº§ */
            opacity: 0;
            /* åˆå§‹ä¸å¯è§ */
            transition: opacity 0.3s;
            /* æ·»åŠ è¿‡æ¸¡æ•ˆæœ */
        }

        /* ä¼˜åŒ–åŠ¨ç”»å®šä¹‰ */
        @keyframes critAnim {
            0% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }

            50% {
                transform: translate(-50%, -50%) scale(2);
            }

            100% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(1);
            }
        }

        /* é•å­å›¾æ ‡æ‚¬æµ®æ•ˆæœ */
        .pickaxe {
            transition: transform 0.3s ease;
        }

        .pickaxe:hover {
            transform: rotate(15deg) scale(1.1);
        }

        @keyframes swing {
            0% {
                transform: rotate(0deg);
            }

            50% {
                transform: rotate(-30deg);
            }

            100% {
                transform: rotate(0deg);
            }
        }

        .swing-animation {
            animation: swing 0.3s ease-in-out;
        }

        /* æš´å‡»é—ªå…‰ç‰¹æ•ˆ */
        @keyframes goldFlash {
            0% {
                opacity: 0;
            }

            50% {
                opacity: 0.8;
            }

            100% {
                opacity: 0;
            }
        }

        .gold-flash {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255, 215, 0, 0.5) 10%, transparent 70%);
            pointer-events: none;
            animation: goldFlash 0.5s;
        }

        /* æš´å‡»æ–‡å­—æ”¾å¤§ç‰¹æ•ˆ */
        @keyframes critScale {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(2);
            }

            100% {
                transform: scale(1);
            }
        }

        .crit-scale {
            animation: critScale 0.5s ease-out;
        }

        #reset-btn {
            z-index: 1000;
            padding: 12px 24px;
            color: white;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }

        #reset-btn:hover {
            background: linear-gradient(145deg, #ff4444, #d11a1a);
            transform: translateY(-2px);
        }

        #reset-btn:active {
            transform: translateY(1px);
        }

        /* æ–°å¢æµ®åŠ¨æ–‡å­—æ ·å¼ */
        .floating-text {
            position: fixed;
            color: #FFD700;
            font-size: 20px;
            font-weight: bold;
            pointer-events: none;
            z-index: 9999;
            animation: floatUp 1s ease-out forwards;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.8);
            white-space: nowrap;
            transform: translateX(-50%);
        }

        @keyframes floatUp {
            0% {
                transform: translate(-50%, 0);
                opacity: 1;
            }

            100% {
                transform: translate(-50%, -50px);
                opacity: 0;
            }
        }

        audio {
            display: none;
        }

        /* æ–°å¢éŸ³ä¹æŒ‰é’®æ ·å¼ */
        #music-btn {
            z-index: 1000;
            padding: 12px 24px;
            color: white;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }

        #music-btn:hover {
            background: linear-gradient(145deg, #5b7fef, #4a6bc5);
            transform: translateY(-2px);
        }

        #music-btn:active {
            transform: translateY(1px);
        }

        /* æ–°å¢ä»»åŠ¡ç³»ç»Ÿæ ·å¼ */
        #quest-container {
            position: fixed;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            width: 280px;
            background: var(--dark-bg);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
            color: white;
            max-height: 90vh;
            overflow-y: auto;
            z-index: 999;
        }

        .quest-item {
            background: var(--button-bg);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #444;
        }

        .quest-item.completed {
            border-color: var(--gold);
        }

        .quest-reward {
            color: var(--gold);
            margin-top: 10px;
            font-weight: bold;
        }
    </style>
</head>

<body>
    <!-- æ–°å¢èƒŒæ™¯éŸ³ä¹ -->
    <audio id="bgm" loop>
        <source src="mine_bgm.mp3" type="audio/mpeg">
        æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘æ’­æ”¾
    </audio>
    <div id="gold-counter">é‡‘å¸: 0</div>
    <div id="prestige-counter"
        style="position: fixed; right: 20px; top: 70px; font-size: 24px; color: #00ff00; padding: 12px 20px; background: rgba(0,0,0,0.8); border-radius: 8px;">
        å£°æœ›: <span id="prestige-value">0</span>
    </div>

    <div class="mine-container">
        <button onclick="mineGold()" style="display: flex; flex-direction: column; align-items: center">
            <img id="pickaxe-icon" src="pickaxe.png" class="pickaxe" style="margin-bottom: 8px" alt="pickaxe">
            æŒ–çŸ¿
        </button>
    </div>

    <div id="crit-message"></div>

    <h2>å•†åº—</h2>
    <div id="shop-container">
        <!-- å°†å…¨éƒ¨å•†å“é¡¹ç§»å…¥å®¹å™¨å†… -->
        <div class="shop-item">
            <h3>é•ç­‰çº§ï¼ˆç­‰çº§ <span id="pickaxe-level">1</span>ï¼‰</h3>
            <p>æ¯æ¬¡ç‚¹å‡»è·å¾— <span id="click-value">1</span> é‡‘å¸</p>
            <button id="upgradePickaxe">å‡çº§ï¼ˆéœ€è¦ <span id="pickaxe-cost">10</span> é‡‘å¸ï¼‰</button>
        </div>

        <div class="shop-item">
            <h3>çŸ¿å·¥åŠ©æ‰‹ï¼ˆ<span id="miner-count">0</span>ï¼‰</h3>
            <p>æ¯ç§’è‡ªåŠ¨è·å¾— <span id="miner-value">0</span> é‡‘å¸</p>
            <button id="buyMiner">é›‡ä½£ï¼ˆéœ€è¦ <span id="miner-cost">50</span> é‡‘å¸ï¼‰</button>
        </div>

        <div class="shop-item">
            <h3>æš´å‡»æ¦‚ç‡ï¼ˆç­‰çº§ <span id="crit-chance-level">1</span>ï¼‰</h3>
            <p>å½“å‰æ¦‚ç‡ï¼š<span id="current-crit-chance">10%</span></p>
            <button id="upgradeCritChance">å‡çº§ï¼ˆéœ€è¦ <span id="crit-chance-cost">100</span> é‡‘å¸ï¼‰</button>
        </div>

        <div class="shop-item">
            <h3>æš´å‡»å€ç‡ï¼ˆç­‰çº§ <span id="crit-multiplier-level">1</span>ï¼‰</h3>
            <p>å½“å‰å€ç‡ï¼š<span id="current-crit-multiplier">2</span>å€</p>
            <button id="upgradeCritMultiplier">å‡çº§ï¼ˆéœ€è¦ <span id="crit-multiplier-cost">150</span> é‡‘å¸ï¼‰</button>
        </div>

        <div class="shop-item">
            <h3>ç¦»çº¿æ”¶ç›Šï¼ˆç­‰çº§ <span id="offline-multiplier-level">1</span>ï¼‰</h3>
            <p>å½“å‰å€ç‡ï¼š<span id="current-offline-multiplier">1</span>å€</p>
            <button id="upgradeOfflineMultiplier">å‡çº§ï¼ˆéœ€è¦ <span id="offline-multiplier-cost">200</span> é‡‘å¸ï¼‰</button>
        </div>
    </div>

    <!-- æ–°å¢ä»»åŠ¡ç³»ç»Ÿ -->
    <div id="quest-container"></div>

    <script>
        // åœ¨è„šæœ¬é¡¶éƒ¨æ·»åŠ å¸¸é‡
        const UPGRADE_MULTIPLIERS = {
            pickaxe: 1.4,
            miner: 1.25,
            critChance: 1.8,
            critMultiplier: 2,
            offline: 2.2
        };
        // åœ¨è„šæœ¬é¡¶éƒ¨æ·»åŠ æŒ–çŸ¿éŸ³æ•ˆæ•°ç»„
        const mineSounds = [
            new Audio('mining1.wav'),
            new Audio('mining2.wav'),
            new Audio('mining3.wav')
        ];
        const critSound = new Audio('Critical.mp3');  // æ–°å¢æš´å‡»éŸ³æ•ˆ
        // åœ¨è„šæœ¬é¡¶éƒ¨æ·»åŠ bgmå˜é‡
        let bgm;

        // ä¿®æ”¹åŸæ¥çš„éŸ³é¢‘åˆå§‹åŒ–éƒ¨åˆ†ï¼ˆæ›¿æ¢åŸæ¥çš„const bgmå£°æ˜ï¼‰
        window.addEventListener('load', function () {
            bgm = document.getElementById('bgm');
            // ...ä¿æŒåŸæœ‰è‡ªåŠ¨æ’­æ”¾é€»è¾‘ä¸å˜...
        });

        // æ–°å¢éŸ³ä¹åˆ‡æ¢å‡½æ•°
        function toggleBGM() {
            const btn = document.getElementById('music-btn');
            if (bgm.paused) {
                bgm.play();
                btn.textContent = "å…³é—­éŸ³ä¹";
            } else {
                bgm.pause();
                btn.textContent = "å¼€å¯éŸ³ä¹";
            }
        }
        // åœ¨è„šæœ¬æœ€å‰é¢æ·»åŠ éŸ³é¢‘å¯¹è±¡
        const upgradeSound = new Audio('BuyUpgrade.wav');
        // åŠ è½½ä¿å­˜æ•°æ®
        let savedData = JSON.parse(localStorage.getItem('goldMinerSave'));
        const defaultValues = {
            gold: 0,
            pickaxeLevel: 1,
            pickaxeCost: 10,
            miners: 0,
            minerCost: 50,
            lastSave: Date.now(),
            critChanceLevel: 1,
            critMultiplierLevel: 1,
            critChanceCost: 100,
            critMultiplierCost: 150,
            offlineMultiplierLevel: 1,
            offlineMultiplierCost: 200,
            prestige: 0
        };

        if (!savedData) {
            savedData = { ...defaultValues };
        } else {
            // å¼ºåˆ¶è½¬æ¢å¹¶éªŒè¯æ‰€æœ‰æ•°å€¼å­—æ®µ
            const numberFields = [
                'gold', 'pickaxeLevel', 'pickaxeCost', 'miners', 'minerCost', 'lastSave',
                'critChanceLevel', 'critMultiplierLevel', 'critChanceCost', 'critMultiplierCost',
                'offlineMultiplierLevel', 'offlineMultiplierCost', 'prestige'
            ];

            numberFields.forEach(field => {
                // æ·»åŠ ||æ“ä½œç¬¦æä¾›é»˜è®¤å€¼
                const defaultValue = defaultValues[field];
                const value = Number(savedData[field] || defaultValue);
                savedData[field] = (!isNaN(value) && value >= 0) ? value : defaultValue;
            });

            // ç¡®ä¿lastSaveä¸ºæœ‰æ•ˆæ—¶é—´æˆ³
            if (savedData.lastSave > Date.now()) {
                savedData.lastSave = Date.now();
            }
        }

        // åˆå§‹åŒ–æ˜¾ç¤º
        //updateDisplay();

        // æ–°å¢æµ®åŠ¨æ–‡å­—æ˜¾ç¤ºå‡½æ•°
        function showFloatingText(amount, isAuto) {
            const floatingText = document.createElement('div');
            floatingText.className = 'floating-text';
            floatingText.textContent = `+${amount}é‡‘å¸${isAuto ? ' (è‡ªåŠ¨)' : ''}`;

            // å®šä½åˆ°ä¸åŒå…ƒç´ 
            const target = isAuto
                ? document.getElementById('gold-counter')
                : document.querySelector('.mine-container button');

            if (target) {
                const rect = target.getBoundingClientRect();
                floatingText.style.left = `${rect.left + rect.width / 2}px`;
                floatingText.style.top = `${rect.top}px`;
            }

            document.body.appendChild(floatingText);
            setTimeout(() => floatingText.remove(), 1000);
        }

        function mineGold() {
            const pickaxe = document.getElementById("pickaxe-icon");
            pickaxe.classList.add("swing-animation");
            setTimeout(() => {
                pickaxe.classList.remove("swing-animation");
            }, 300);

            // éšæœºæ’­æ”¾æŒ–çŸ¿éŸ³æ•ˆ
            const randomSound = mineSounds[Math.floor(Math.random() * mineSounds.length)];
            randomSound.currentTime = 0; // é‡ç½®æ’­æ”¾ä½ç½®
            randomSound.play();

            let base = window.gameState.pickaxeLevel;
            if (Math.random() < window.gameState.critChance) {
                base *= window.gameState.critMultiplier;
                // æ’­æ”¾æš´å‡»éŸ³æ•ˆ
                critSound.currentTime = 0; // é‡ç½®æ’­æ”¾ä½ç½®
                critSound.play();

                showCritMessage(`æš´å‡»! x${window.gameState.critMultiplier.toFixed(1)}`);
                addGoldFlash();
                document.getElementById("crit-message").classList.add("crit-scale");
                setTimeout(() => {
                    document.getElementById("crit-message").classList.remove("crit-scale");
                }, 500);
            }
            window.gameState.gold += Math.round(base);
            showFloatingText(base, false);
            updateDisplay();
            updateQuests(); // æ·»åŠ æ­¤è¡Œä»¥æ›´æ–°ä»»åŠ¡è¿›åº¦
        }

        function addGoldFlash() {
            const flash = document.createElement("div");
            flash.className = "gold-flash";
            document.body.appendChild(flash);
            setTimeout(() => flash.remove(), 500);
        }

        // ä¿®æ”¹æ˜¾ç¤ºæš´å‡»æ¶ˆæ¯çš„å‡½æ•°
        function showCritMessage(msg) {
            const critMsg = document.getElementById("crit-message");
            critMsg.style.display = "block";
            critMsg.textContent = msg;
            critMsg.style.animation = "critAnim 1s";

            setTimeout(() => {
                critMsg.style.display = "none";
            }, 1000);
        }

        function getClickValue() {
            return window.gameState.pickaxeLevel;
        }

        // å‡çº§ç³»ç»Ÿå’Œè‡ªåŠ¨ç”Ÿäº§ç³»ç»Ÿä¿æŒä¸å˜...

        // ä¿å­˜æ¸¸æˆæ•°æ®
        function saveGame() {
            const saveData = {
                gold: window.gameState.gold,
                pickaxeLevel: window.gameState.pickaxeLevel,
                pickaxeCost: window.gameState.pickaxeCost,
                miners: window.gameState.miners,
                minerCost: window.gameState.minerCost,
                lastSave: Date.now(), // ä¿å­˜å½“å‰æ—¶é—´ï¼Œç¡®ä¿ä¸‹æ¬¡è®¡ç®—ç¦»çº¿æ—¶é—´æ­£ç¡®
                critChanceLevel: window.gameState.critChanceLevel,
                critMultiplierLevel: window.gameState.critMultiplierLevel,
                critChanceCost: window.gameState.critChanceCost,
                critMultiplierCost: window.gameState.critMultiplierCost,
                offlineMultiplierLevel: window.gameState.offlineMultiplierLevel,
                offlineMultiplierCost: window.gameState.offlineMultiplierCost,
                quests: window.gameState.quests,
                prestige: window.gameState.prestige// æ·»åŠ å£°æœ›å±æ€§
            };
            localStorage.setItem('goldMinerSave', JSON.stringify(saveData));
        }

        // æ¯5ç§’è‡ªåŠ¨ä¿å­˜
        setInterval(saveGame, 5000);

        // å…³é—­é¡µé¢æ—¶ä¿å­˜
        window.addEventListener('beforeunload', saveGame);

        setInterval(() => {
            if (window.gameState.miners > 0) {
                const autoGold = Math.round(window.gameState.miners * Math.pow(1.15, window.gameState.pickaxeLevel) * 0.3);
                window.gameState.gold += Math.round(autoGold);
                showFloatingText(Math.round(autoGold), true);
                updateDisplay();
                updateQuests();
            }
        }, 1000);

        function updateDisplay() {
            document.getElementById("gold-counter").textContent = `é‡‘å¸: ${window.gameState.gold}`;
            document.getElementById("pickaxe-level").textContent = window.gameState.pickaxeLevel;
            document.getElementById("click-value").textContent = window.gameState.pickaxeLevel; // getClickValue() å·²ç®€åŒ–
            document.getElementById("pickaxe-cost").textContent = window.gameState.pickaxeCost;
            document.getElementById("miner-count").textContent = window.gameState.miners;
            (document.getElementById("miner-value").textContent =
                Math.round(window.gameState.miners * window.gameState.pickaxeLevel * 0.5));
            document.getElementById("miner-cost").textContent = window.gameState.minerCost;
            document.getElementById("crit-chance-level").textContent = window.gameState.critChanceLevel;
            document.getElementById("current-crit-chance").textContent = `${(window.gameState.critChance * 100).toFixed(1)}%`;
            document.getElementById("crit-chance-cost").textContent = window.gameState.critChanceCost;
            document.getElementById("crit-multiplier-level").textContent = window.gameState.critMultiplierLevel;
            document.getElementById("current-crit-multiplier").textContent = window.gameState.critMultiplier.toFixed(1);
            document.getElementById("crit-multiplier-cost").textContent = window.gameState.critMultiplierCost;
            document.getElementById("offline-multiplier-level").textContent = window.gameState.offlineMultiplierLevel;
            document.getElementById("current-offline-multiplier").textContent = window.gameState.offlineMultiplier.toFixed(1);
            document.getElementById("offline-multiplier-cost").textContent = window.gameState.offlineMultiplierCost;
            document.getElementById("prestige-value").textContent = window.gameState.prestige;

            // ä¿®å¤æŒ‰é’®ç¦ç”¨é€»è¾‘
            document.querySelectorAll("button").forEach(btn => {
                if (btn.textContent.includes("éœ€è¦")) {
                    const match = btn.textContent.match(/\d+/);
                    if (match) {
                        const cost = parseInt(match[0], 10);
                        btn.disabled = window.gameState.gold < cost; // ä½¿ç”¨ window.gameState
                    } else {
                        btn.disabled = true;
                    }
                }
            });
        }
        function resetGame() {
            if (confirm("ç¡®å®šè¦é‡ç½®æ¸¸æˆå—ï¼Ÿ")) {
                // ç›´æ¥é‡ç½® window.gameState
                window.gameState.gold = 0;
                window.gameState.pickaxeLevel = 1;
                window.gameState.pickaxeCost = 10;
                window.gameState.miners = 0;
                window.gameState.minerCost = 50;
                window.gameState.critChanceLevel = 1;
                window.gameState.critMultiplierLevel = 1;
                window.gameState.critChanceCost = 100;
                window.gameState.critMultiplierCost = 150;
                window.gameState.offlineMultiplierLevel = 1;
                window.gameState.offlineMultiplierCost = 200;
                window.gameState.critChance = 0.1;
                window.gameState.critMultiplier = 2;
                window.gameState.offlineMultiplier = 1;
                window.gameState.prestige = 0;
                // æ–°å¢ä»»åŠ¡é‡ç½®
                window.gameState.quests = generateRandomQuests(3); // â† è¿™æ˜¯å…³é”®ä¿®å¤

                localStorage.removeItem('goldMinerSave');
                updateDisplay();
                updateQuests(); // â† æ›´æ–°ä»»åŠ¡æ˜¾ç¤º
                alert("æ¸¸æˆå·²é‡ç½®ï¼");
            }
        }
        // åœ¨åŠ è½½ä¿å­˜æ•°æ®åæ·»åŠ æ—¶é—´æ ¼å¼åŒ–å‡½æ•°å’Œå¼¹çª—é€»è¾‘
        function formatTime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            const parts = [];
            if (hours > 0) parts.push(`${hours}å°æ—¶`);
            if (minutes > 0) parts.push(`${minutes}åˆ†é’Ÿ`);
            if (secs > 0 || parts.length === 0) parts.push(`${secs}ç§’`); // è‡³å°‘æ˜¾ç¤ºç§’æ•°
            return parts.join('');
        }
        // åœ¨é¡µé¢åŠ è½½åå°è¯•æ’­æ”¾éŸ³ä¹
        window.addEventListener('load', function () {
            const bgm = document.getElementById('bgm');
            // å¤„ç†æµè§ˆå™¨è‡ªåŠ¨æ’­æ”¾é™åˆ¶
            document.body.addEventListener('click', function firstPlay() {
                bgm.play();
                document.body.removeEventListener('click', firstPlay);
            });

            // å°è¯•è‡ªåŠ¨æ’­æ”¾
            bgm.play().catch(() => {
                console.log('éœ€è¦ç”¨æˆ·äº¤äº’åæ‰èƒ½æ’­æ”¾éŸ³é¢‘');
            });
        });

        // ä»»åŠ¡ç±»å‹é…ç½®
        const QUEST_TYPES = [
            {
                type: 'collect',
                desc: 'æ”¶é›† {target} é‡‘å¸',
                progress: (game) => game.gold,
                reward: (level) => Math.max(1, Math.floor(level / 2)) // åŠ¨æ€å¥–åŠ±
            },
            {
                type: 'pickaxe',
                desc: 'å‡çº§é•å­ {target} æ¬¡',
                progress: (game) => game.pickaxeLevel - 1,
                reward: (level) => Math.max(1, Math.floor(level / 2)) // åŠ¨æ€å¥–åŠ±
            },
            {
                type: 'miner',
                desc: 'é›‡ä½£ {target} ä¸ªçŸ¿å·¥',
                progress: (game) => game.miners,
                reward: (level) => Math.max(1, Math.floor(level / 2)) // åŠ¨æ€å¥–åŠ±
            }
        ];

        // ç”Ÿæˆéšæœºä»»åŠ¡
        function generateRandomQuests(count) {
            return Array.from({ length: count }, (_, i) => {
                const type = QUEST_TYPES[Math.floor(Math.random() * QUEST_TYPES.length)];
                // æ›´å¹³æ»‘çš„éš¾åº¦æ›²çº¿
                const baseDifficulty = 2 + Math.floor(window.gameState.prestige / 3);
                // åŠ¨æ€ä¹˜æ•°æ”¹ä¸ºå¯¹æ•°å¢é•¿
                const dynamicMultiplier = 1 + Math.log1p(window.gameState.prestige * 0.5);

                let target;
                switch (type.type) {
                    case 'collect':
                        target = Math.round((baseDifficulty * 30) * dynamicMultiplier);
                        break;
                    case 'pickaxe':
                        target = Math.round(baseDifficulty * dynamicMultiplier);
                        break;
                    case 'miner':
                        target = Math.round(baseDifficulty * 1.5 * dynamicMultiplier);
                        break;
                    default:
                        target = baseDifficulty;
                }

                // æ·»åŠ ä¸Šé™é˜²æ­¢æ•°å€¼è†¨èƒ€
                target = Math.min(target, baseDifficulty * 100);
                return {
                    id: Date.now() + i,
                    type: type.type,
                    desc: type.desc.replace('{target}', target),
                    target: target,
                    progress: 0,
                    reward: Math.max(1, Math.floor(baseDifficulty / 2)), // åŠ¨æ€å¥–åŠ±
                    completed: false
                };
            });
        }

        // æ›´æ–°ä»»åŠ¡æ˜¾ç¤º
        function updateQuests() {
            const container = document.getElementById('quest-container');
            container.innerHTML = '';

            window.gameState.quests.forEach(quest => {
                const progress = QUEST_TYPES.find(t => t.type === quest.type).progress(window.gameState);
                const isCompleted = progress >= quest.target;

                const questEl = document.createElement('div');
                questEl.className = `quest-item ${isCompleted ? 'completed' : ''}`;
                questEl.innerHTML = `
            <div>${quest.desc}</div>
            <div>è¿›åº¦: ${Math.min(progress, quest.target)}/${quest.target}</div>
            <div class="quest-reward">
                ${isCompleted ? 'å·²å®Œæˆ' : `å¥–åŠ±: ${quest.reward}å£°æœ›`}
            </div>
        `;

                if (isCompleted && !quest.completed) {
                    questEl.addEventListener('click', () => claimQuestReward(quest.id));
                }

                container.appendChild(questEl);
            });
        }

        // é¢†å–ä»»åŠ¡å¥–åŠ±
        function claimQuestReward(questId) {
            const quest = window.gameState.quests.find(q => q.id === questId);
            if (!quest || quest.completed) return; // é˜²æ­¢é‡å¤å¤„ç†

            quest.completed = true; // ç«‹å³æ ‡è®°ä¸ºå·²å®Œæˆ
            window.gameState.prestige += quest.reward;
            showFloatingText(`+${quest.reward}å£°æœ›`, true);
            updateDisplay();
            saveGame();

            // ç«‹å³ç”Ÿæˆæ–°ä»»åŠ¡å¹¶æ›´æ–°æ˜¾ç¤º
            window.gameState.quests = window.gameState.quests.map(q =>
                q.id === questId ? generateRandomQuests(1)[0] : q
            );
            updateQuests();
        }
    </script>
    <button id="music-btn" onclick="toggleBGM()"
        style="position: fixed; bottom: 70px; right: 20px; background: linear-gradient(145deg, #4a6fdd, #3a5bb5);">
        å…³é—­éŸ³ä¹
    </button>
</body>
<button id="reset-btn" onclick="resetGame()"
    style="position: fixed; bottom: 20px; right: 20px; background: linear-gradient(145deg, #dc3545, #c82333);">é‡ç½®æ¸¸æˆ</button>

</html>